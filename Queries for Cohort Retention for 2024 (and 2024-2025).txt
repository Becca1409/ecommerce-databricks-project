Cohort Retention for 2024 (for 2024-2025 I simply removed the WHERE clause)

1. COHORT SIZE

SELECT
  cohort_month,
  COUNT(DISTINCT customer_id) AS new_customers
FROM ecommerce_2024.cohort_customers
GROUP BY cohort_month
ORDER BY cohort_month;

2. RETENTION TO 2ND PURCHASE

SELECT
  cohort_month,
  COUNT(*) AS cohort_size,

  SUM(CASE WHEN days_to_second_purchase <= 30 THEN 1 ELSE 0 END) * 1.0 / COUNT(*) AS retention_1_month,
  SUM(CASE WHEN days_to_second_purchase <= 60 THEN 1 ELSE 0 END) * 1.0 / COUNT(*) AS retention_2_months,
  SUM(CASE WHEN days_to_second_purchase <= 90 THEN 1 ELSE 0 END) * 1.0 / COUNT(*) AS retention_3_months

FROM ecommerce_2024.cohort_customers
WHERE cohort_month >= '2024-01-01' AND cohort_month < '2025-01-01'
GROUP BY cohort_month
ORDER BY cohort_month;


3. REPEAT PURCHASE DEPTH

WITH orders_per_customer AS (
  SELECT
    c.customer_id,
    c.cohort_month,
    COUNT(DISTINCT o.order_id) AS total_orders
  FROM ecommerce_2024.cohort_customers c
  JOIN ecommerce_2024.clean_orders o
    ON c.customer_id = o.customer_id
  GROUP BY c.customer_id, c.cohort_month
)

SELECT
  cohort_month,
  COUNT(*) AS cohort_size,
  SUM(CASE WHEN total_orders >= 2 THEN 1 ELSE 0 END) * 1.0 / COUNT(*) AS repeat_2plus,
  SUM(CASE WHEN total_orders >= 3 THEN 1 ELSE 0 END) * 1.0 / COUNT(*) AS repeat_3plus,
  SUM(CASE WHEN total_orders >= 4 THEN 1 ELSE 0 END) * 1.0 / COUNT(*) AS repeat_4plus
FROM orders_per_customer
WHERE cohort_month >= '2024-01-01' AND cohort_month < '2025-01-01'
GROUP BY cohort_month
ORDER BY cohort_month;



